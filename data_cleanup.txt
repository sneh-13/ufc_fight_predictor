#Sneh: code used to cleanup scraper data (object variables -> numeric varaibles)

import pandas as pd
import numpy as np

# Load the data
matches = pd.read_csv("ufc_comprehensive_data.csv", index_col=0)

# Create a copy to work with
matches_cleaned = matches.copy()

# Function to clean and convert height to inches
def clean_height(height_str):
    if pd.isna(height_str) or height_str == '':
        return np.nan
    height_str = str(height_str).strip()
    
    # Check if it's in feet and inches format (e.g., "5'11")
    if "'" in height_str:
        try:
            parts = height_str.replace('"', '').split("'")
            feet = float(parts[0])
            inches = float(parts[1]) if len(parts) > 1 and parts[1] else 0
            total_inches = feet * 12 + inches
            return total_inches
        except:
            return np.nan
    else:
        # Already in inches
        try:
            inches = float(height_str.replace('"', '').replace('in', '').strip())
            return inches
        except:
            return np.nan

# Function to clean weight - updated to handle various formats
def clean_weight(weight_str):
    if pd.isna(weight_str):
        return np.nan
    
    # If it's already a number (int or float), return it as float
    if isinstance(weight_str, (int, float)):
        return float(weight_str)
    
    # Convert to string and clean
    weight_str = str(weight_str).strip()
    
    if weight_str == '' or weight_str.lower() == 'nan':
        return np.nan
    
    try:
        # Remove various possible formats
        cleaned = weight_str.replace('lbs', '').replace('lb', '').replace('pounds', '').strip()
        # Also remove any spaces that might be between number and unit
        cleaned = cleaned.replace(' ', '')
        return float(cleaned)
    except:
        # If all else fails, try to convert directly
        try:
            return float(weight_str)
        except:
            return np.nan

# Function to clean reach in inches
def clean_reach(reach_str):
    if pd.isna(reach_str) or reach_str == '':
        return np.nan
    reach_str = str(reach_str).strip()
    try:
        # Remove quotes and 'in' if present, keep in inches
        inches = float(reach_str.replace('"', '').replace('in', '').strip())
        return inches
    except:
        return np.nan

# Function to clean percentage values
def clean_percentage(perc_str):
    if pd.isna(perc_str) or perc_str == '':
        return np.nan
    perc_str = str(perc_str).strip()
    try:
        # Remove percentage sign and convert
        cleaned = perc_str.replace('%', '').strip()
        return float(cleaned)
    except:
        return np.nan

# Debug: Check original weight column values before conversion
print("Original weight column sample (first 10 non-null values):")
print("-" * 40)
weight_sample = matches['weight'].dropna().head(10)
print(weight_sample)
print(f"Weight column dtype: {matches['weight'].dtype}")
print()

# Convert height (inches), weight (lbs), and reach (inches)
matches_cleaned['height'] = matches_cleaned['height'].apply(clean_height)
matches_cleaned['weight'] = matches_cleaned['weight'].apply(clean_weight)
matches_cleaned['reach'] = matches_cleaned['reach'].apply(clean_reach)

# Convert stance to numeric (1=orthodox, 2=southpaw, 3=switch)
stance_mapping = {
    'orthodox': 1,
    'southpaw': 2,
    'switch': 3
}

# Handle stance conversion (case-insensitive)
def convert_stance(stance_str):
    if pd.isna(stance_str) or stance_str == '':
        return np.nan
    stance_str = str(stance_str).lower().strip()
    return stance_mapping.get(stance_str, np.nan)

matches_cleaned['stance'] = matches_cleaned['stance'].apply(convert_stance)

# Convert accuracy and defense percentages
matches_cleaned['striking_accuracy'] = matches_cleaned['striking_accuracy'].apply(clean_percentage)
matches_cleaned['striking_defense'] = matches_cleaned['striking_defense'].apply(clean_percentage)
matches_cleaned['takedown_accuracy'] = matches_cleaned['takedown_accuracy'].apply(clean_percentage)
matches_cleaned['takedown_defense'] = matches_cleaned['takedown_defense'].apply(clean_percentage)

# Verify the conversions
print("Data types after conversion:")
print("-" * 40)
columns_to_check = ['height', 'weight', 'reach', 'stance', 
                    'striking_accuracy', 'striking_defense', 
                    'takedown_accuracy', 'takedown_defense']

for col in columns_to_check:
    print(f"{col}: {matches_cleaned[col].dtype}")

print("\nSample of converted data:")
print("-" * 40)
print(matches_cleaned[columns_to_check].head(10))

print("\nStatistics for numeric columns:")
print("-" * 40)
if matches_cleaned['height'].notna().any():
    print(f"Height (inches): min={matches_cleaned['height'].min():.1f}, max={matches_cleaned['height'].max():.1f}, mean={matches_cleaned['height'].mean():.1f}")
else:
    print("Height: No valid data")

if matches_cleaned['weight'].notna().any():
    print(f"Weight (lbs): min={matches_cleaned['weight'].min():.1f}, max={matches_cleaned['weight'].max():.1f}, mean={matches_cleaned['weight'].mean():.1f}")
else:
    print("Weight: No valid data")

if matches_cleaned['reach'].notna().any():
    print(f"Reach (inches): min={matches_cleaned['reach'].min():.1f}, max={matches_cleaned['reach'].max():.1f}, mean={matches_cleaned['reach'].mean():.1f}")
else:
    print("Reach: No valid data")

print("\nMissing values in converted columns:")
print("-" * 40)
for col in columns_to_check:
    missing = matches_cleaned[col].isna().sum()
    total = len(matches_cleaned)
    print(f"{col}: {missing} missing ({missing/total*100:.1f}%)")

# Additional debug for weight column if still having issues
print("\nWeight column debugging:")
print("-" * 40)
print(f"Total rows: {len(matches_cleaned)}")
print(f"Non-null weight values: {matches_cleaned['weight'].notna().sum()}")
print(f"Null weight values: {matches_cleaned['weight'].isna().sum()}")
if matches_cleaned['weight'].notna().any():
    print(f"Sample of converted weight values:")
    print(matches_cleaned['weight'].dropna().head(10))

# Save the cleaned data to a new CSV file
output_filename = "ufc_data_numeric_converted.csv"
matches_cleaned.to_csv(output_filename)
print(f"\nData saved to: {output_filename}")

# Display all data types to confirm changes
print("\nAll data types in the cleaned dataset:")
print("-" * 40)
print(matches_cleaned.dtypes)